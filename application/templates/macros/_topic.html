{# 问题的话题编辑框 #}
{% macro topic_wap(topic, attr=None) %}
    {% if attr %}
        {% set topic = topic[attr] %}
    {% endif %}

    <div class="topic-wap">
        <a class="label label-default topic" href="{{ url_for('topic.view', uid=topic.id) }}"
           data-id="{{ topic.id }}">
            {{ topic.name }}</a>
        <a href="javascript: void(0)" class="btn-delete-topic" data-id="{{ topic.id }}">
            <span class="fa fa-close"></span>
        </a>
    </div>
{% endmacro %}


{# 关注话题组件 #}
{% macro topic_follow_wap(topic, dark=False) %}
    {% set followed = topic.followed_by_user() %}
    <div class="dc-topic-follow-wap btn {% if followed %}btn-default{% else %}btn-dark{% endif %}
        {% if followed %}followed{% endif %}" data-id="{{ topic.id }}">
        <a href="javascript: void(0)" class="btn-follow-topic">
            <span class="for-follow">关注</span><span class="for-unfollow">不再关注</span></a>
        <span class="divider">|</span>
        <span class="followers-count">{{ topic.followers.count() }}</span>
    </div>

    <script>
        (function () {
            // 关注话题
            $('.dc-topic-follow-wap').onOnce('click', function () {
                var topicId = $(this).data('id');
                var followed = $(this).hasClass('followed');
                var _this = $(this);
                var $count = _this.find('.followers-count');
                var url = urlFor('topic.follow', {uid: topicId});

                if (!g.signin) {
                    window.location = urlFor('account.signin');
                    return;
                }

                $.ajax({
                    url: url,
                    method: 'post',
                    dataType: 'json'
                }).done(function (response) {
                    if (response.result) {
                        if (response.followed) {
                            if (!_this.hasClass('followed')) {
                                _this.addClass('followed').addClass('btn-default').removeClass('btn-dark');
                            }
                        } else {
                            _this.removeClass('followed').addClass('btn-dark').removeClass('btn-default');
                        }

                        $count.text(response.followers_count);
                    }
                });
            });
        })();
    </script>
{% endmacro %}


{# 话题页header #}
{% macro topic_page_header(topic, active='view') %}
    <div class="dc-topic-page-header">
        <div class="commands">
            {{ topic_follow_wap(topic, dark=True) }}

            <a href="{{ url_for('topic.admin', uid=topic.id) }}" class="btn btn-default btn-admin-topic"
               title="话题管理">
                <span class="fa fa-gear"></span>
            </a>
        </div>

        <div class="topic-wap">
            <div class="media">
                <div class="media-left">
                    <img src="{{ topic.avatar_url }}" alt=""/>
                </div>
                <div class="media-body">
                    <div class="topic-name">{{ topic.name }}</div>

                    {% if topic.wiki_preview %}
                        <div class="topic-wiki">
                            {{ topic.wiki_preview }} <a href="{{ url_for('topic.wiki', uid=topic.id) }}">查看百科</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs">
            <li role="presentation" {% if active == 'view' %}class="active"{% endif %}>
                <a href="{{ url_for('topic.view', uid=topic.id) }}">讨论</a>
            </li>
            <li role="presentation" {% if active == 'rank' %}class="active"{% endif %}>
                <a href="{{ url_for('topic.rank', uid=topic.id) }}">榜单</a>
            </li>
            <li role="presentation" {% if active == 'wiki' %}class="active"{% endif %}>
                <a href="{{ url_for('topic.wiki', uid=topic.id) }}">百科</a>
            </li>
        </ul>
    </div>
{% endmacro %}


{# 直接父话题编辑框 #}
{% macro parent_topic_edit_wap(parent_topic) %}
    <li class="parent-topic-edit-wap">
        <a href="{{ url_for('topic.view', uid=parent_topic.id) }}">
            {{ parent_topic.name }}</a>
        <a href="javascript: void(0)" class="btn-remove-parent-topic"
           data-parent-topic-id="{{ parent_topic.id }}">移除</a>
    </li>
{% endmacro %}


{# 直接子话题编辑框 #}
{% macro child_topic_edit_wap(child_topic) %}
    <li class="child-topic-edit-wap">
        <a href="{{ url_for('topic.view', uid=child_topic.id) }}">
            {{ child_topic.name }}</a>
        <a href="javascript: void(0)" class="btn-remove-child-topic"
           data-child-topic-id="{{ child_topic.id }}">移除</a>
    </li>
{% endmacro %}


{# 直接子话题编辑框 #}
{% macro topic_synonym_edit_wap(topic_synonym) %}
    <li class="child-topic-edit-wap">
        <span>{{ topic_synonym.synonym }}</span>
        <a href="javascript: void(0)" class="btn-remove-topic-synonym"
           data-id="{{ topic_synonym.id }}">移除</a>
    </li>
{% endmacro %}


{# 话题讨论页header #}
{% macro topic_discuss_page_header(topic, active="top") %}
    <div class="btn-group">
        <a type="button" href="{{ url_for('topic.view', uid=topic.id) }}"
           class="btn btn-default {% if active == 'top' %}active{% endif %}">
            精彩回答</a>
        <a type="button" href="{{ url_for('topic.waiting_for_answer', uid=topic.id) }}"
           class="btn btn-default {% if active == 'waiting_for_answer' %}active{% endif %}">
            等待回答</a>
        <a type="button" href="{{ url_for('topic.questions', uid=topic.id) }}"
           class="btn btn-default {% if active == 'questions' %}active{% endif %}">
            全部问题</a>
    </div>
{% endmacro %}


{# 话题讨论页sidebar #}
{% macro topic_discuss_page_sidebar(topic) %}
    <a href="{{ url_for('topic.logs', uid=topic.id) }}">话题日志</a>

    <h3>父话题</h3>

    {% if topic.root %}
        <span class="label label-primary">根话题</span>
    {% else %}
        {% for parent_topic in topic.parent_topics %}
            <a href="{{ url_for('topic.view', uid=parent_topic.id) }}">
                {{ parent_topic.name }}
            </a>
        {% endfor %}
    {% endif %}

    <h3>子话题</h3>

    {% for child_topic in topic.child_topics %}
        <a href="{{ url_for('topic.view', uid=child_topic.id) }}">
            {{ child_topic.name }}
        </a>
    {% endfor %}
{% endmacro %}


{# 擅长话题 #}
{% macro render_expert_topics(expert_topics) %}
    {% for expert_topic in expert_topics %}
        {% set topic = expert_topic.topic %}
        <div class="media">
            <div class="media-left">
                <a href="{{ url_for('topic.view', uid=topic.id) }}">
                    <img src="{{ topic.avatar_url }}" alt=""/>
                </a>
            </div>
            <div class="media-body">
                <div>
                    <a href="{{ url_for('topic.view', uid=topic.id) }}">{{ topic.name }}</a>
                </div>
                <div class="meta">
                    {{ expert_topic.answers_count }} 个回答，收获 {{ expert_topic.upvotes_count }} 个赞同
                </div>
            </div>
        </div>
    {% endfor %}
{% endmacro %}
