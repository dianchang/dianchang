{% from "macros/_topic.html" import topic_follow_wap %}
{% from "macros/_answer.html" import render_answer_commands, render_answer %}
{% from "macros/_question.html" import question_follow_wap, render_question %}
{% from "macros/_topic.html" import topic_follow_wap, render_expert_topic %}

{# 关注用户 #}
{% macro user_follow_wap(user, dark=False, sm=False, with_count=True) %}
    {% set followed = g.user and user.followed_by_user(g.user.id) %}

    <div class="dc-user-follow-wap btn
        {% if sm %}btn-sm{% endif %} {% if dark %}dark{% endif %}
        {% if followed %}
            btn-default
        {% else %}
            {% if dark %}btn-dark{% else %}btn-light{% endif %}
        {% endif %}
        {% if g.user and g.user.id == user.id %}myself{% endif %}
        {% if followed %}followed{% endif %}" data-id="{{ user.id }}">

        {% if g.user and g.user.id == user.id %}
            我自己
        {% else %}
            <span class="for-follow">关注</span><span class="for-unfollow">不再关注</span>
            {% if with_count %}
                <span class="divider">|</span>
                <span class="followers-count">{{ user.followers.count() }}</span>
            {% endif %}
        {% endif %}
    </div>

    <script>
        $('.dc-user-follow-wap').onOnce('click', function () {
            var userId = $(this).data('id');
            var followed = $(this).hasClass('followed');
            var myself = $(this).hasClass('myself');
            var _this = $(this);
            var $count = _this.find('.followers-count');
            var url = urlFor('user.follow', {uid: userId});

            if (!g.signin) {
                window.location = urlFor('account.signin');
                return;
            }

            if (myself) {
                return;
            }

            $.ajax({
                url: url,
                method: 'post',
                dataType: 'json'
            }).done(function (response) {
                if (response.result) {
                    if (response.followed) {
                        _this.addClass('followed').addClass('btn-default');
                        if (_this.hasClass('dark')) {
                            _this.removeClass('btn-dark');
                        } else {
                            _this.removeClass('btn-light');
                        }
                    } else {
                        _this.removeClass('followed').removeClass('btn-default');

                        if (_this.hasClass('dark')) {
                            _this.addClass('btn-dark');
                        } else {
                            _this.addClass('btn-light');
                        }
                    }

                    $count.text(response.followers_count);
                }
            });
        });
    </script>
{% endmacro %}


{# 用户页页头 #}
{% macro user_page_header(user, active='profile', preview=False, avatar_uptoken='', background_uptoken='', with_tabs=True) %}
    <div class="dc-user-page-header
        {% if user.background %}has-background{% endif %}
        {% if preview %}preview{% endif %}
        {% if not g.user or g.user.id != user.id %}forbid-edit{% endif %}">

        <div class="commands">
            {% if not g.user or g.user.id != user.id or preview %}
                {{ user_follow_wap(user) }}

                <button type="button" class="dc-hide-commands-trigger btn btn-default">
                    <span class="fa fa-chevron-down"></span>

                    <div class="dc-hide-commands">
                        <a href="#" target="_blank">向他提问</a>
                        <a href="javascript: void(0)"
                           class="btn-block-user {% if g.user and user.blocked_by_user(g.user.id) %}blocked{% endif %}"
                           data-id="{{ user.id }}">
                            <span class="for-blocked">取消屏蔽</span>
                            <span class="for-un-blocked">屏蔽此人</span></a>
                        <a href="javascript: void(0)" class="btn-report-user" data-id="{{ user.id }}">举报此人</a>
                    </div>
                </button>
            {% endif %}

            {% if g.user and g.user.id == user.id and not preview %}
                <a href="javascript: void(0)" class="btn btn-default btn-upload-background">
                    设置封面图</a>
                <input type="file" class="input-upload-background" name="background"/>

                <button type="button" class="dc-hide-commands-trigger btn btn-default">
                    <span class="fa fa-chevron-down"></span>

                    <div class="dc-hide-commands">
                        <a href="{{ user.profile_url }}?preview=1" target="_blank">以他人视角查看</a>
                    </div>
                </button>
            {% endif %}
        </div>

        <div class="background-wap"
             {% if user.background %}style="background-image: url({{ user.background_url }});"{% endif %}></div>

        <div class="container text-center">
            <div class="avatar-wap">
                <img src="{{ user.avatar_url }}" class="img-circle user-avatar" alt=""/>
                {% if g.user and g.user.id == user.id %}
                    <span class="btn-upload-avatar">上传头像</span>
                    <input type="file" name="avatar"/>
                {% endif %}
            </div>

            <div class="name">{{ user.name }}</div>

            <div class="desc-wap">
                <div class="desc-outer-wap {% if g.user and g.user.id == user.id %}myself{% endif %}
                    {% if not user.desc %}empty{% endif %}">
                    <span class="desc-inner-wap">
                        <span class="desc">
                            {% if user.desc %}{{ user.desc }}{% endif %}
                        </span>
                        <span class="text-light for-empty-desc">尚无描述</span>
                        <span class="btn-edit-desc">
                            <span class="fa fa-pencil"></span> 编辑
                        </span>
                    </span>
                </div>
                <div class="desc-edit-wap">
                    <input type="text" class="form-control input-desc" name="desc"
                           placeholder="一句话简介" autocomplete="off"/>
                    <button type="button" class="btn btn-default btn-submit-desc">保存</button>
                </div>
            </div>

            <div class="user-meta-wap">
                <div class="meta-outer-wap {% if g.user and g.user.id == user.id %}myself{% endif %}
                    {% if not user.location and not user.organization and not user.position %}empty{% endif %}">
                    <span class="meta-inner-wap">
                        <span class="user-meta">
                            {% for attr in ['location', 'organization', 'position'] %}
                                {% if user[attr] %}
                                    <span class="{{ attr }}">{{ user[attr] }}</span>
                                    <span class="divider">·</span>
                                {% endif %}
                            {% endfor %}
                        </span>

                        <span class="text-light for-empty-meta">尚未填写相关资料</span>

                        <span class="btn-edit-meta">
                            <span class="fa fa-pencil"></span> 编辑
                        </span>
                    </span>
                </div>

                <div class="meta-edit-wap">
                    <input type="text" class="form-control input-location" name="location"
                           placeholder="地点" autocomplete="off"/>
                    <input type="text" class="form-control input-organization" name="organization"
                           placeholder="组织" autocomplete="off"/>
                    <input type="text" class="form-control input-position" name="position"
                           placeholder="职位" autocomplete="off"/>
                    <button type="button" class="btn btn-default btn-submit-meta">保存</button>
                </div>
            </div>

            <div class="follows-data">
                <a class="item btn-show-followings" href="javascript: void(0)">
                    <span class="count">{{ user.followings.count() }}</span>
                    <br/>
                    关注
                </a><a class="item btn-show-followers" href="javascript: void(0)">
                <span class="count">{{ user.followers.count() }}</span>
                <br/>
                关注者
            </a>
            </div>

            {% if with_tabs %}
                <ul class="nav nav-tabs nav-tabs-block">
                    <li {% if active == 'profile' %}class="active"{% endif %}>
                        <a href="{{ user.profile_url }}">主页</a>
                    </li>
                    <li {% if active == 'questions_and_answers' %}class="active"{% endif %}>
                        <a href="{{ url_for('user.questions_and_answers', uid=user.id) }}">问答</a>
                    </li>
                    <li {% if active == 'achievements' %}class="active"{% endif %}>
                        <a href="{{ url_for('user.achievements', uid=user.id) }}">成就</a>
                    </li>
                </ul>
            {% endif %}
        </div>

        <div class="follow-bg followings-bg">
            <div class="outer-wap">
                <div class="selector-wap">
                    <span class="selector selector-show-followed-users active">关注的人</span>
                    <span class="selector selector-show-followed-topics">关注的话题</span>
                </div>

                <div class="followed-users-wap empty">
                    <span class="fa fa-spin fa-spinner"></span>
                </div>

                <div class="followed-topics-wap empty">
                    <span class="fa fa-spin fa-spinner"></span>
                </div>
            </div>

            <span class="btn-close-bg btn-close-followings-bg">×</span>
        </div>

        <div class="follow-bg followers-bg">
            <div class="outer-wap">
                <div class="selector-wap">
                    <span class="selector selector-show-followers active no-border">关注者</span>
                </div>

                <div class="followers-wap empty">
                    <span class="fa fa-spin fa-spinner"></span>
                </div>
            </div>

            <span class="btn-close-bg btn-close-followings-bg">×</span>
        </div>
    </div>

    <script>
        (function () {
            var $userHeader = $('.dc-user-page-header');

            // 上传背景图
            var bgUploader = simple.uploader({
                url: 'http://upload.qiniu.com',
                fileKey: 'file',
                connectionCount: 1,
                params: {
                    token: '{{ background_uptoken }}'
                }
            });

            $userHeader.find('.btn-upload-background').click(function () {
                $userHeader.find("input[name='background']").click();
            });

            $userHeader.find("input[name='background']").on('change', function (e) {
                bgUploader.upload(this.files);
            });

            bgUploader.on('uploadsuccess', function (e, file, response) {
                if (response.result) {
                    $('.background-wap').css({
                        'background-image': 'url(' + response.url + ')'
                    });
                    $('.dc-user-page-header').addClass('has-background');
                }
            });

            // 上传头像
            var avatarUploader = simple.uploader({
                url: 'http://upload.qiniu.com',
                fileKey: 'file',
                connectionCount: 1,
                params: {
                    token: '{{ avatar_uptoken }}'
                }
            });

            $('.btn-upload-avatar').click(function () {
                $userHeader.find("input[name='avatar']").click();
            });

            $userHeader.find("input[name='avatar']").on('change', function (e) {
                avatarUploader.upload(this.files);
            });

            avatarUploader.on('uploadsuccess', function (e, file, response) {
                if (response.result) {
                    $('.user-avatar').attr('src', response.url);
                }
            });

            // 显示desc编辑框
            $userHeader.find('.btn-edit-desc').click(function () {
                var desc = $.trim($userHeader.find('.desc').text());

                $(this).parents('.desc-wap').addClass('edit');
                $('.input-desc').val(desc).focus();

            });

            // 更新desc
            $userHeader.find('.btn-submit-desc').click(function () {
                var $input = $(this).prev();
                var desc = $.trim($input.val());

                $.ajax({
                    url: urlFor('user.update_desc'),
                    method: 'post',
                    dataType: 'json',
                    data: {
                        desc: desc
                    }
                }).done(function (response) {
                    if (response.result) {
                        $userHeader.find('.desc').text(desc);
                        $userHeader.find('.desc-wap').removeClass('edit');

                        if (desc === '') {
                            $userHeader.find('.desc-outer-wap').addClass('empty');
                        } else {
                            $userHeader.find('.desc-outer-wap').removeClass('empty');
                        }
                    }
                });
            });

            // 显示位置、组织、职位编辑框
            $('.btn-edit-meta').click(function () {
                var location, organization, position;

                if ($userHeader.find('.location').length !== 0) {
                    location = $.trim($('.location').text());
                } else {
                    location = "";
                }

                if ($userHeader.find('.organization').length !== 0) {
                    organization = $.trim($('.organization').text());
                } else {
                    organization = "";
                }

                if ($userHeader.find('.position').length !== 0) {
                    position = $.trim($('.position').text());
                } else {
                    position = "";
                }

                $(this).parents('.user-meta-wap').addClass('edit');

                $userHeader.find('.input-location').val(location).focus();
                $userHeader.find('.input-organization').val(organization);
                $userHeader.find('.input-position').val(position);
            });

            // 更新位置、组织、职位
            $userHeader.find('.btn-submit-meta').click(function () {
                var location = $.trim($userHeader.find('.input-location').val());
                var organization = $.trim($userHeader.find('.input-organization').val());
                var position = $.trim($userHeader.find('.input-position').val());

                $.ajax({
                    url: urlFor('user.update_meta_info'),
                    method: 'post',
                    dataType: 'json',
                    data: {
                        location: location,
                        organization: organization,
                        position: position
                    }
                }).done(function (response) {
                    var html = "";

                    if (response.result) {
                        if (location) {
                            html += "<span class='location'>" + location + "</span> <span class='divider'>·</span>";
                        }
                        if (organization) {
                            html += " <span class='organization'>" + organization + "</span> <span class='divider'>·</span>";
                        }
                        if (position) {
                            html += " <span class='position'>" + position + "</span> <span class='divider'>·</span>";
                        }

                        $userHeader.find('.user-meta').html(html);
                        $userHeader.find('.user-meta-wap').removeClass('edit');

                        if (location === '' && organization === '' && position === '') {
                            $userHeader.find('.meta-outer-wap').addClass('empty');
                        } else {
                            $userHeader.find('.meta-outer-wap').removeClass('empty');
                        }
                    }
                });
            });

            // 举报用户
            $userHeader.find('.btn-report-user').click(function () {
                var id = parseInt($(this).data('id'));
                var _this = $(this);

                $.ajax({
                    url: urlFor('user.report', {uid: id}),
                    dataType: 'json',
                    method: 'post'
                }).done(function (response) {
                    if (response.result) {
                        _this.text('已举报');
                    }
                });
            });

            // 屏蔽用户
            $userHeader.find('.btn-block-user').click(function () {
                var id = $(this).data('id');
                var _this = $(this);

                $.ajax({
                    url: urlFor('user.block', {uid: id}),
                    method: 'post',
                    dataType: 'json'
                }).done(function (response) {
                    if (response.result) {
                        if (response.blocked) {
                            _this.addClass('blocked');
                        } else {
                            _this.removeClass('blocked');
                        }
                    }
                });
            });

            // 打开关注弹窗
            $userHeader.on('click', '.btn-show-followings', function () {
                disableScroll();
                $userHeader.find('.followings-bg').fadeIn('fast');
                $userHeader.find('.selector-show-followed-users').click()
            });

            // 切换到关注的人
            $userHeader.on('click', '.selector-show-followed-users', function () {
                var userId = {{ user.id }};
                var $followedUsersWap = $userHeader.find('.followed-users-wap');
                var $followedTopicsWap = $userHeader.find('.followed-topics-wap');

                $(this).addClass('active').siblings().removeClass('active');
                $followedUsersWap.show();
                $followedTopicsWap.hide();

                if ($followedUsersWap.hasClass('empty')) {
                    $.ajax({
                        url: urlFor('user.get_followed_users_html', {uid: userId}),
                        method: 'post',
                        dataType: 'json'
                    }).done(function (response) {
                        if (response.result) {
                            $followedUsersWap.removeClass('empty').html(response.html);
                        }
                    });
                }
            });

            // 切换到关注的话题
            $userHeader.on('click', '.selector-show-followed-topics', function () {
                var userId = {{ user.id }};
                var $followedTopicsWap = $userHeader.find('.followed-topics-wap');
                var $followedUsersWap = $userHeader.find('.followed-users-wap');

                $(this).addClass('active').siblings().removeClass('active');
                $followedTopicsWap.show();
                $followedUsersWap.hide();

                if ($followedTopicsWap.hasClass('empty')) {
                    $.ajax({
                        url: urlFor('user.get_followed_topics_html', {uid: userId}),
                        method: 'post',
                        dataType: 'json'
                    }).done(function (response) {
                        if (response.result) {
                            $followedTopicsWap.removeClass('empty').html(response.html);
                        }
                    });
                }
            });

            // 打开关注者弹窗
            $userHeader.on('click', '.btn-show-followers', function () {
                var userId = {{ user.id }};
                var $followersWap = $userHeader.find('.followers-wap');

                disableScroll();
                $('.followers-bg').fadeIn('fast');

                if ($followersWap.hasClass('empty')) {
                    $.ajax({
                        url: urlFor('user.get_followers_html', {uid: userId}),
                        method: 'post',
                        dataType: 'json'
                    }).done(function (response) {
                        if (response.result) {
                            $followersWap.removeClass('empty').html(response.html);
                        }
                    });
                }
            });

            // 关闭弹出框
            $('.btn-close-bg').click(function () {
                $(this).parents('.follow-bg').fadeOut('fast');
                enableScroll();
            });

            $(document).keyup(function (e) {
                if (e.keyCode == 27) {
                    $('.follow-bg').fadeOut('fast');
                    enableScroll();
                }
            });
        })();
    </script>
{% endmacro %}


{# 问题FEED #}
{% macro render_question_feed(question) %}
    <div class="content">
        <div class="question-title">
            <a href="{{ url_for('question.view', uid=question.id) }}"
               class="question-title">
                {{ question.title }}
            </a>
        </div>

        <div class="other text-light">
            {% set answers_count = question.answers_count %}
            {% if answers_count %}
                {{ answers_count }} 个回答
            {% else %}
                还没有回答
            {% endif %}
            <span class="divider">·</span>
            提问于 {{ question.created_at|timesince }}
        </div>

        <div class="commands">
            {{ question_follow_wap(question) }}
            <a href="{{ url_for('question.view', uid=question.id) }}#answer"
               class="btn btn-default btn-answer">
                写答案</a>
        </div>
    </div>
{% endmacro %}


{# 用户主页FEED #}
{% macro render_user_feeds(feeds) %}
    {% for feed in feeds %}
        {% if feed.kind == USER_FEED_KIND.ASK_QUESTION %}
            <div class="dc-home-feed feed-follow-question">
                <div class="meta">
                    <span>提出了问题</span>
                    <span class="time">{{ feed.created_at|timesince }}</span>
                </div>
                {{ render_question_feed(feed.question) }}
            </div>
        {% elif feed.kind == USER_FEED_KIND.ANSWER_QUESTION %}
            <div class="dc-home-feed feed-answer-question">
                <div class="meta">
                    <span>回答了问题</span>
                    <span class="time">{{ feed.created_at|timesince }}</span>
                </div>
                {{ render_answer(feed.answer, with_topics=False) }}
            </div>
        {% elif feed.kind == USER_FEED_KIND.UPVOTE_ANSWER %}
            <div class="dc-home-feed feed-upvote-answer">
                <div class="meta">
                        <span>赞同了 <a href="{{ feed.answer.user.profile_url }}" class="text-light dc-show-user-card"
                                     data-id="{{ feed.answer.user_id }}">
                            {{ feed.answer.user.name }}</a> 的回答</span>
                    <span class="time">{{ feed.created_at|timesince }}</span>
                </div>
                {{ render_answer(feed.answer, with_topics=False) }}
            </div>
        {% elif feed.kind == USER_FEED_KIND.FOLLOW_QUESTION %}
            <div class="dc-home-feed feed-follow-question">
                <div class="meta">
                    <span>关注了问题</span>
                    <span class="time">{{ feed.created_at|timesince }}</span>
                </div>
                {{ render_question_feed(feed.question) }}
            </div>
        {% elif feed.kind == USER_FEED_KIND.FOLLOW_TOPIC %}
            <div class="dc-home-feed feed-follow-topic">
                <div class="meta">
                    <span>关注了话题</span>
                    <span class="time">{{ feed.created_at|timesince }}</span>
                </div>

                <div class="content">
                    <div class="media">
                        <div class="media-left">
                            <a href="{{ url_for('topic.view', uid=feed.topic_id) }}">
                                <img src="{{ feed.topic.avatar_url }}" class="img-rounded dc-show-topic-card"
                                     data-id="{{ feed.topic_id }}" alt=""/>
                            </a>
                        </div>
                        <div class="media-body">
                            <div class="topic-name">
                                <a href="{{ url_for('topic.view', uid=feed.topic_id) }}" class="dc-show-topic-card"
                                   data-id="{{ feed.topic_id }}">
                                    {{ feed.topic.name }}</a>
                            </div>
                            <div class="text-light">
                                {{ feed.topic.questions_count }} 个相关问题
                            </div>
                        </div>
                    </div>

                    {{ topic_follow_wap(feed.topic) }}
                </div>
            </div>
        {% elif feed.kind == USER_FEED_KIND.FOLLOW_USER %}
            <div class="dc-home-feed feed-follow-user">
                {% set following_user = feed.following %}
                <div class="meta">
                    <span>关注了人</span>
                    <span class="time">{{ feed.created_at|timesince }}</span>
                </div>

                <div class="content">
                    <div class="media">
                        <div class="media-left">
                            <a href="{{ following_user.profile_url }}">
                                <img src="{{ following_user.avatar_url }}" class="img-circle dc-show-user-card"
                                     alt="" data-id="{{ following_user.id }}"/>
                            </a>
                        </div>
                        <div class="media-body">
                            <div class="user-name">
                                <a href="{{ following_user.profile_url }}" class="dc-show-user-card"
                                   data-id="{{ following_user.id }}">
                                    {{ following_user.name }}</a>
                            </div>
                            <div class="desc text-light">{{ following_user.desc or "" }}</div>
                        </div>
                    </div>

                    {{ user_follow_wap(following_user) }}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}


{# 话题讨论页header #}
{% macro compose_drafts_page_header(active="compose") %}
    <div class="dc-compose-drafts-page-header no-margin-top clearfix">
        <a href="{{ url_for('user.compose') }}"
           class="{% if active == 'compose' %}active{% endif %}">
            可能适合你回答的问题</a>
        <a href="{{ url_for('user.drafts') }}"
           class="{% if active == 'drafts' %}active{% endif %}">
            草稿 <span class="drafts-count">{{ g.user.drafts_count }}</span></a>
    </div>
{% endmacro %}


{# 用户卡片 #}
{% macro user_card(user) %}
    <div class="dc-user-card">
        <div class="user-wap">
            <div class="avatar-wap">
                <a href="{{ user.profile_url }}">
                    <img src="{{ user.avatar_url }}" class="img-circle" alt=""/>
                </a>
            </div>

            <div class="name">
                <a href="{{ user.profile_url }}">{{ user.name }}</a>
            </div>

            {% if user.desc %}
                <div class="desc">{{ user.desc }}</div>
            {% endif %}

            <div class="other">
                {% if user.organization %}
                    <span class="organization">{{ user.organization }}</span>
                {% endif %}

                {% if user.organization and user.position %}
                    <span class="divider">·</span>
                {% endif %}

                {% if user.position %}
                    <span class="position">{{ user.position }}</span>
                {% endif %}
            </div>
        </div>

        <div class="follow-wap">
            {{ user_follow_wap(user, dark=True) }}
        </div>
    </div>
{% endmacro %}


{# 通知发起者 #}
{% macro render_notification_senders(senders, action) %}
    {% set senders_count = senders.count() %}

    <div class="dc-noti-sender">
        {% if senders_count <= 2 %}
            {% for sender in senders %}
                <a href="{{ sender.profile_url }}" class="sender dc-img-text-link-wap dc-show-user-card"
                   data-id="{{ sender.id }}">
                    <img src="{{ sender.avatar_url }}" alt="" class="img-circle"/>
                    <span class="sender-name">{{ sender.name }}</span></a>
            {% endfor %}
        {% else %}
            <a href="{{ sender.profile_url }}" class="sender">
                <img src="{{ sender.avatar_url }}" alt="" class="img-circle dc-show-user-card"
                     data-id="{{ sender.id }}"/></a>
        {% endif %}

        <span class="action">
        {% if senders_count == 3 %}3 人{% elif senders_count > 3 %}等 {{ senders_count }} 人{% endif %}{{ action }}
    </span>
    </div>
{% endmacro %}


{# 消息类通知 #}
{% macro render_message_notifications(notifications) %}
    {% for noti in notifications %}
        {% if noti.kind == NOTIFICATION_KIND.ANSWER_FROM_ASKED_QUESTION %}
            <div class="noti-in-nav noti-message {% if noti.unread %}unread{% endif %}"
                 data-href="{{ url_for('question.view', uid=noti.answer.question_id, answer_id=noti.answer_id) }}">
                {{ render_notification_senders(noti.senders, action='回答了你提出的问题') }}

                <div class="question-title">
                    <a href="{{ url_for('question.view', uid=noti.answer.question_id) }}">
                        {{ noti.answer.question.title }}</a>
                </div>

                <div class="answer-content text-light">
                    {% if noti.answer.content_preview %}
                        {{ noti.answer.content_preview|truncate(40, true) }}
                    {% endif %}
                </div>

                <span class="new-flag"></span>
            </div>
        {% elif noti.kind == NOTIFICATION_KIND.COMMENT_ANSWER %}
            <div class="noti-in-nav noti-message {% if noti.unread %}unread{% endif %}"
                 data-href="{{ url_for('question.view', uid=noti.answer_comment.question_id, answer_id=noti.answer_comment.answer_id, comment_id=noti.answer_comment_id) }}">
                {{ render_notification_senders(noti.senders, action='评论了你的回答') }}

                <div class="answer-content text-light">
                    {% if noti.answer_comment.content %}
                        {{ noti.answer_comment.content|truncate(40, true) }}
                    {% endif %}
                </div>

                <span class="new-flag"></span>
            </div>
        {% elif noti.kind == NOTIFICATION_KIND.REPLY_ANSWER_COMMENT %}
            <div class="noti-in-nav noti-message {% if noti.unread %}unread{% endif %}"
                 data-href="{{ url_for('question.view', uid=noti.answer_comment.question_id, answer_id=noti.answer_comment.answer_id, comment_id=noti.answer_comment_id) }}">
                {{ render_notification_senders(noti.senders, action='回复了你的评论') }}

                <div class="answer-comment text-light">
                    {% if noti.answer_comment.content %}
                        {{ noti.answer_comment.content|truncate(40, true) }}
                    {% endif %}
                </div>

                <span class="new-flag"></span>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}


{# 用户类通知 #}
{% macro render_user_notifications(notifications) %}
    {% for noti in notifications %}
        {% for follower in noti.senders %}
            <div class="noti-in-nav noti-user media {% if noti.unread %}unread{% endif %}">
                <div class="media-left">
                    <a href="{{ follower.profile_url }}">
                        <img src="{{ follower.avatar_url }}" alt="" class="dc-show-user-card img-circle"
                             data-id="{{ follower.id }}"/>
                    </a>
                </div>

                <div class="media-body">
                    <div class="user-info">
                        <a href="{{ follower.profile_url }}" class="dc-show-user-card"
                           data-id="{{ follower.id }}">{{ follower.name }}</a>
                        {% if follower.desc %}，{{ follower.desc }}{% endif %}
                    </div>
                    <div class="other-info text-light">
                        {% if follower.organization %}{{ follower.organization }}{% endif %}
                        {% if follower.organization and follower.position %}<span class="divider">·</span>{% endif %}
                        {% if follower.position %}{{ follower.position }}{% endif %}
                    </div>
                </div>

                {{ user_follow_wap(follower, sm=True, with_count=False) }}

                <span class="new-flag"></span>
            </div>
        {% endfor %}
    {% endfor %}
{% endmacro %}


{# 感谢类通知 #}
{% macro render_thanks_notifications(notifications) %}
    {% for noti in notifications %}
        {% if noti.kind == NOTIFICATION_KIND.THANK_ANSWER %}
            <div class="noti-in-nav noti-thanks {% if noti.unread %}unread{% endif %}"
                 data-href="{{ url_for('question.view', uid=noti.answer.question_id, answer_id=noti.answer_id) }}">
                {{ render_notification_senders(noti.senders, action='感谢了你的回答') }}

                <div class="question-title">
                    <a href="{{ url_for('question.view', uid=noti.answer.question_id) }}">
                        {{ noti.answer.question.title }}</a>
                </div>

                <div class="answer-content text-light">
                    {% if noti.answer.content_preview %}
                        {{ noti.answer.content_preview|truncate(40, true) }}
                    {% endif %}
                </div>

                <span class="new-flag"></span>
            </div>
        {% elif noti.kind == NOTIFICATION_KIND.UPVOTE_ANSWER %}
            <div class="noti-in-nav noti-thanks {% if noti.unread %}unread{% endif %}"
                 data-href="{{ url_for('question.view', uid=noti.answer.question_id, answer_id=noti.answer_id) }}">
                {{ render_notification_senders(noti.senders, action='赞同了你的回答') }}

                <div class="question-title">
                    <a href="{{ url_for('question.view', uid=noti.answer.question_id) }}">
                        {{ noti.answer.question.title }}</a>
                </div>

                <div class="answer-content text-light">
                    {% if noti.answer.content_preview %}
                        {{ noti.answer.content_preview|truncate(40, true) }}
                    {% endif %}
                </div>

                <span class="new-flag"></span>
            </div>
        {% elif noti.kind == NOTIFICATION_KIND.LIKE_ANSWER_COMMENT %}
            <div class="noti-in-nav noti-thanks {% if noti.unread %}unread{% endif %}"
                 data-href="{{ url_for('question.view', uid=noti.answer_comment.question_id, answer_id=noti.answer_comment.answer_id, comment_id=noti.answer_comment_id) }}">
                {{ render_notification_senders(noti.senders, action='赞了你的评论') }}

                <div class="answer-comment text-light">
                    {% if noti.answer_comment.content %}
                        {{ noti.answer_comment.content|truncate(40, true) }}
                    {% endif %}
                </div>

                <span class="new-flag"></span>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}


{# 用户类通知 #}
{% macro render_followed_users(followings) %}
    {% for following in followings %}
        {% set user = following.following %}

        <div class="followed-user media">
            <div class="media-left">
                <a href="{{ user.profile_url }}">
                    <img src="{{ user.avatar_url }}" alt="" class="dc-show-user-card img-circle"
                         data-id="{{ user.id }}"/>
                </a>
            </div>

            <div class="media-body">
                <div class="user-info">
                    <a href="{{ user.profile_url }}" class="dc-show-user-card followed-user-name"
                       data-id="{{ user.id }}">{{ user.name }}</a>{% if user.desc %}，{{ user.desc }}{% endif %}
                </div>
                <div class="user-other-info text-light">
                    {% if user.organization %}{{ user.organization }}{% endif %}
                    {% if user.organization and user.position %}
                        <span class="divider">·</span>
                    {% endif %}
                    {% if user.position %}{{ user.position }}{% endif %}
                </div>
            </div>

            {{ user_follow_wap(user) }}
        </div>
    {% endfor %}
{% endmacro %}


{# 关注的话题 #}
{% macro render_followed_topics(followed_topics) %}
    {% for followed_topic in followed_topics %}
        {% set topic = followed_topic.topic %}

        <div class="followed-topic media">
            <div class="media-left">
                <a href="{{ url_for('topic.view', uid=topic.id) }}">
                    <img src="{{ topic.avatar_url }}" class="img-rounded dc-show-topic-card"
                         data-id={{ topic.id }} alt=""/>
                </a>
            </div>

            <div class="media-body">
                <div class="topic-name-wap">
                    <a href="{{ url_for('topic.view', uid=topic.id) }}" class="dc-show-topic-card"
                       data-id="{{ topic.id }}">{{ topic.name }}</a>
                </div>
                <div class="questions-count text-light">
                    {{ topic.all_questions_count }} 个相关问题
                </div>
            </div>

            {{ topic_follow_wap(topic) }}
        </div>
    {% endfor %}
{% endmacro %}


{# 关注者 #}
{% macro render_followers(followers) %}
    {% for follower in followers %}
        {% set user = follower.follower %}

        <div class="follower media">
            <div class="media-left">
                <a href="{{ user.profile_url }}">
                    <img src="{{ user.avatar_url }}" alt="" class="dc-show-user-card img-circle"
                         data-id="{{ user.id }}"/>
                </a>
            </div>

            <div class="media-body">
                <div class="user-info">
                    <a href="{{ user.profile_url }}" class="dc-show-user-card follower-name"
                       data-id="{{ user.id }}">{{ user.name }}</a>{% if user.desc %}，{{ user.desc }}{% endif %}
                </div>
                <div class="user-other-info text-light">
                    {% if user.organization %}{{ user.organization }}{% endif %}
                    {% if user.organization and user.position %}
                        <span class="divider">·</span>
                    {% endif %}
                    {% if user.position %}{{ user.position }}{% endif %}
                </div>
            </div>

            {{ user_follow_wap(user) }}
        </div>
    {% endfor %}
{% endmacro %}


{# 用户的擅长话题 #}
{% macro render_user_expert_topics(user) %}
    {% set myself = g.user and g.user.id == user.id %}

    <div class="dc-expert-topics {% if user.expert_topics.count() == 8 %}full{% endif %}
        {% if myself %}myself{% endif %}">
        <div class="expert-topics">
            {% for expert_topic in user.expert_topics %}
                {{ render_expert_topic(expert_topic, myself=myself) }}
            {% endfor %}
        </div>

        {% if myself %}
            <div class="add-expert-topic-wap">
                <a href="javascript: void(0)" class="btn-add-expert-topic" title="添加擅长话题"
                   data-placement="right">
                    <span class="fa fa-plus"></span>
                </a>

                <form class="form-wap">
                    <input type="text" name="topic" class="form-control" placeholder="搜索话题，回车添加"/>

                    <div class="commands">
                        <button type="button" class="btn btn-sm btn-default btn-finish-expert-topic">完成</button>
                    </div>
                </form>
            </div>

            <div class="text-light full-tip">最多设置 8 个擅长话题</div>
        {% endif %}
    </div>

    <script>
        (function () {
            var $expertTopicsOuterWap = $('.dc-expert-topics');
            var myself = $expertTopicsOuterWap.hasClass('myself');
            var $expertTopics = $expertTopicsOuterWap.find('.expert-topics');
            var $topicInput = $expertTopicsOuterWap.find("input[name='topic']");

            // 移除擅长话题
            $expertTopics.on('click', '.btn-remove-topic', function () {
                var id = $(this).data('id');
                var $topic = $(this).parents('.expert-topic');

                if (!myself) {
                    return false;
                }

                $.ajax({
                    url: urlFor('topic.remove_expert', {uid: id}),
                    dataType: 'json',
                    method: 'post'
                }).done(function (response) {
                    if (response.result) {
                        $topic.detach();
                    }
                });
            });

            // 添加话题经验
            $expertTopics.on('click', '.btn-add-experience', function () {
                var $expertTopicWap = $(this).parents('.expert-topic');
                var $textarea = $expertTopicWap.find('textarea');

                if (!myself) {
                    return false;
                }

                $expertTopicWap.addClass('edit');
                $textarea.focus();
            });

            // 编辑话题经验
            $expertTopics.on('click', '.btn-edit-experience', function () {
                var $expertTopicWap = $(this).parents('.expert-topic');
                var $experience = $expertTopicWap.find('.experience');
                var experience = $.trim($experience.text());
                var $textarea = $expertTopicWap.find('textarea');

                if (!myself) {
                    return false;
                }

                $expertTopicWap.addClass('edit');
                $textarea.val(experience).focus();
            });

            // 取消编辑话题经验
            $expertTopicsOuterWap.find('.btn-cancel-edit-experience').click(function () {
                var $expertTopicWap = $(this).parents('.expert-topic');

                if (!myself) {
                    return false;
                }

                $expertTopicWap.removeClass('edit');
            });

            // 提交话题经验
            $expertTopicsOuterWap.find('.btn-submit-experience').click(function () {
                var $expertTopicWap = $(this).parents('.expert-topic');
                var $experience = $expertTopicWap.find('.experience');
                var $textarea = $expertTopicWap.find('textarea');
                var experience = $.trim($textarea.val());
                var topicId = $(this).data('topic-id');

                if (!myself) {
                    return false;
                }

                $.ajax({
                    url: urlFor('topic.update_experience', {uid: topicId, compose: 1}),
                    method: 'post',
                    dataType: 'json',
                    data: {
                        experience: experience
                    }
                }).done(function (response) {
                    if (response.result) {
                        $expertTopicWap.removeClass('edit');
                        $experience.text(experience);

                        if (experience === "") {
                            $expertTopicWap.addClass('empty');
                        } else {
                            $expertTopicWap.removeClass('empty');
                        }
                    }
                });
            });

            // 添加擅长话题
            $expertTopicsOuterWap.find('.btn-add-expert-topic').tooltip().click(function () {
                var $wap = $(this).parents('.add-expert-topic-wap');


                if (!myself) {
                    return false;
                }

                $wap.addClass('edit');
                $topicInput.focus();
            });

            // 完成添加擅长话题
            $expertTopicsOuterWap.find('.btn-finish-expert-topic').click(function () {
                var $wap = $(this).parents('.add-expert-topic-wap');

                if (!myself) {
                    return false;
                }

                $wap.removeClass('edit');
            });

            if (myself) {
                // 拖拽排序
                var sortable = new Sortable($expertTopics.first()[0], {
                    onEnd: function (evt) {
                        var show_orders = [];

                        $expertTopicsOuterWap.find('.expert-topic').each(function (index, element) {
                            var originalShowOrder = parseInt($(element).data('show-order'));
                            var id = parseInt($(element).data('id'));

                            if (index !== originalShowOrder) {
                                console.log(id + ", " + index);
                                show_orders.push({
                                    'id': id,
                                    'show_order': index
                                });
                            }
                        });

                        if (show_orders.length !== 0) {
                            $.ajax({
                                url: urlFor('topic.update_show_order'),
                                method: 'post',
                                dataType: 'json',
                                data: {
                                    show_orders: JSON.stringify(show_orders)
                                }
                            }).done(function (response) {
                                if (response.result) {
                                    $('.expert-topic').each(function (index, element) {
                                        $(element).data('show-order', index);
                                    });
                                }
                            });
                        }
                    }
                });

                // $topicInput 启用 Typeahead 自动完成
                $topicInput.initTopicTypeahead({
                    block: true,
                    small: true,
                    params: {
                        limit: 6
                    },
                    callback: function (e, topic) {
                        var _this = $(this);
                        var $outerWap = $(this).parents('.expert-topics-outer-wap');
                        var data;

                        if (typeof topic.create === 'undefined') {
                            data = {id: topic.id};
                        } else {
                            data = {name: topic.name};
                        }

                        $.ajax({
                            url: urlFor('topic.add_expert'),
                            method: 'post',
                            dataType: 'json',
                            data: data
                        }).done(function (response) {
                            if (response.result) {
                                $('.expert-topics').append(response.html);

                                if (response.full) {
                                    $outerWap.addClass('full');
                                    _this.parents('.add-expert-topic-wap').removeClass('edit');
                                } else {
                                    $outerWap.removeClass('full');
                                }
                            }

                            $topicInput.typeahead('val', '');
                        });
                    }
                });
            }
        })();
    </script>
{% endmacro %}


{# 用户首页feed #}
{% macro render_user_home_feeds(feeds) %}
    {% for feed in feeds %}
        {% if feed.kind == HOME_FEED_KIND.FOLLOWING_ASK_QUESTION %}
            {{ render_question(feed.question, user=feed.question.user) }}
        {% elif feed.kind == HOME_FEED_KIND.FOLLOWING_FOLLOW_QUESTION %}
            {{ render_question(feed.question, user=feed.sender, action='关注了') }}
        {% elif feed.kind == HOME_FEED_KIND.FOLLOWING_ANSWER_QUESTION %}
            <div class="action text-light">
                <a href="{{ feed.sender.profile_url }}" class="dc-show-user-card dc-img-text-link-wap"
                   data-id="{{ feed.sender_id }}">
                    <img src="{{ feed.sender.avatar_url }}" alt="" class="img-circle"/>
                    <span class="name">{{ feed.sender.name }}</span></a> 回答了问题
            </div>
            {{ render_answer(feed.answer, with_topics=False) }}
        {% elif feed.kind == HOME_FEED_KIND.FOLLOWING_UPVOTE_ANSWER %}
            <div class="action text-light">
                <a href="{{ feed.sender.profile_url }}" class="dc-show-user-card dc-img-text-link-wap"
                   data-id="{{ feed.sender_id }}">
                    <img src="{{ feed.sender.avatar_url }}" alt="" class="img-circle"/>
                    <span class="name">{{ feed.sender.name }}</span></a>
                赞同了回答
            </div>
            {{ render_answer(feed.answer, with_topics=False) }}
        {% elif feed.kind == HOME_FEED_KIND.WAITING_FOR_ANSWER_QUESTION_FROM_EXPERT_TOPIC %}
            {# TODO #}
        {% elif feed.kind == HOME_FEED_KIND.GOOD_ANSWER_FROM_FOLLOWED_TOPIC %}
            {# TODO #}
        {% elif feed.kind == HOME_FEED_KIND.NEW_ANSWER_FROM_FOLLOWED_TOPIC %}
            {# TODO #}
        {% endif %}
    {% endfor %}
{% endmacro %}


{# 用户通知 #}
{% macro render_all_notifications(notifications) %}
    {% for noti in notifications %}
        <div class="noti">
            {% if noti.kind == NOTIFICATION_KIND.ANSWER_FROM_ASKED_QUESTION %}
                <div class="noti-body"
                     data-href="{{ url_for('question.view', uid=noti.answer.question_id, answer_id=noti.answer_id) }}">
                    {# 某人回答了你提出的问题 #}
                    <div class="header">
                        {{ render_notification_senders(noti.senders, action='回答了你提出的问题') }}
                    </div>
                    <div class="content">
                        <div class="question-title">
                            <a href="{{ url_for('question.view', uid=noti.answer.question_id) }}">
                                {{ noti.answer.question.title }}
                            </a>
                        </div>

                        <div class="answer-content">{{ noti.answer.content|safe }}</div>

                        {#                        {{ render_answer_commands(noti.answer) }}#}
                    </div>

                    {% if noti.unread %}
                        <div class="new-flag"></div>
                    {% endif %}
                </div>
            {% elif noti.kind == NOTIFICATION_KIND.UPVOTE_ANSWER %}
                <div class="noti-body"
                     data-href="{{ url_for('question.view', uid=noti.answer.question_id, answer_id=noti.answer_id) }}">

                    {# 某人赞同了你的回答 #}
                    <div class="header">
                        {{ render_notification_senders(noti.senders, action='赞同了你的回答') }}
                    </div>

                    <div class="content">
                        <div class="question-title">
                            <a href="{{ url_for('question.view', uid=noti.answer.question_id) }}">
                                {{ noti.answer.question.title }}</a>
                        </div>

                        <div class="answer-content">
                            {{ noti.answer.content|safe }}
                        </div>

                        {#                        {{ render_answer_commands(noti.answer) }}#}
                    </div>

                    {% if noti.unread %}
                        <div class="new-flag"></div>
                    {% endif %}
                </div>
            {% elif noti.kind == NOTIFICATION_KIND.THANK_ANSWER %}
                <div class="noti-body"
                     data-href="{{ url_for('question.view', uid=noti.answer.question_id, answer_id=noti.answer_id) }}">

                    {# 某人感谢了你的回答 #}
                    <div class="header">
                        {{ render_notification_senders(noti.senders, action='感谢了你的回答') }}
                    </div>

                    <div class="content">
                        <div class="question-title">
                            <a href="{{ url_for('question.view', uid=noti.answer.question_id) }}">
                                {{ noti.answer.question.title }}</a>
                        </div>

                        <div class="answer-content">
                            {{ noti.answer.content|safe }}
                        </div>

                        {#                        {{ render_answer_commands(noti.answer) }}#}
                    </div>

                    {% if noti.unread %}
                        <div class="new-flag"></div>
                    {% endif %}
                </div>
            {% elif noti.kind == NOTIFICATION_KIND.COMMENT_ANSWER %}
                <div class="noti-body"
                     data-href="{{ url_for('question.view', uid=noti.answer_comment.question_id, answer_id=noti.answer_comment.answer_id, comment_id=noti.answer_comment_id) }}">

                    {# 评论了回答 #}
                    <div class="header">
                        {{ render_notification_senders(noti.senders, action='评论了你的回答') }}
                    </div>

                    <div class="content">
                        <div class="question-title">
                            <a href="{{ url_for('question.view', uid=noti.answer_comment.question_id) }}">
                                {{ noti.answer_comment.question.title }}</a>
                        </div>

                        <div class="answer-comment">
                            {{ noti.answer_comment.content|safe }}
                        </div>
                    </div>

                    {% if noti.unread %}
                        <div class="new-flag"></div>
                    {% endif %}
                </div>
            {% elif noti.kind == NOTIFICATION_KIND.REPLY_ANSWER_COMMENT %}
                <div class="noti-body"
                     data-href="{{ url_for('question.view', uid=noti.answer_comment.question_id, answer_id=noti.answer_comment.answer_id, comment_id=noti.answer_comment_id) }}">

                    {# 回复了评论 #}
                    <div class="header">
                        {{ render_notification_senders(noti.senders, action='回复了你的评论') }}
                    </div>

                    <div class="content">
                        <div class="question-title">
                            <a href="{{ url_for('question.view', uid=noti.answer_comment.question_id) }}">
                                {{ noti.answer_comment.question.title }}</a>
                        </div>

                        <div class="answer-comment">
                            {{ noti.answer_comment.content|safe }}
                        </div>
                    </div>

                    {% if noti.unread %}
                        <div class="new-flag"></div>
                    {% endif %}
                </div>
            {% elif noti.kind == NOTIFICATION_KIND.LIKE_ANSWER_COMMENT %}
                <div class="noti-body"
                     data-href="{{ url_for('question.view', uid=noti.answer_comment.question_id, answer_id=noti.answer_comment.answer_id, comment_id=noti.answer_comment_id) }}">

                    {# 赞了评论 #}
                    <div class="header">
                        {{ render_notification_senders(noti.senders, action='赞了你的评论') }}
                    </div>

                    <div class="content">
                        <div class="answer-comment">
                            {{ noti.answer_comment.content|safe }}
                        </div>
                    </div>

                    {% if noti.unread %}
                        <div class="new-flag"></div>
                    {% endif %}
                </div>
            {% elif noti.kind == NOTIFICATION_KIND.GOOD_ANSWER_FROM_FOLLOWED_TOPIC %}
                {# TODO #}
                <div class="noti-body"
                     data-href="{{ url_for('question.view', uid=noti.question_id) }}"></div>
            {% elif noti.kind == NOTIFICATION_KIND.SYSTEM_NOTI %}
                {# TODO #}
                <div class="noti-body"></div>
            {% elif noti.kind == NOTIFICATION_KIND.HIDE_ANSWER %}
                {# TODO #}
                <div class="noti-body"></div>
            {% endif %}

            {% if noti.last_in_that_day(g.user.id) %}
                <div class="date-wap">
                    <div class="day">{{ noti.created_at.date()|day }}</div>
                    <div class="month">{{ noti.created_at.date()|cn_month }}</div>
                </div>
            {% endif %}
        </div>
    {% endfor %}
{% endmacro %}
