{% from "macros/_topic.html" import topic_follow_wap %}
{% from "macros/_answer.html" import render_answer_commands, render_answer %}
{% from "macros/_question.html" import question_follow_wap %}

{# 关注用户 #}
{% macro user_follow_wap(user, dark=False) %}
    {% set followed = user.followed_by_user() %}

    <div class="dc-user-follow-wap btn {% if dark %}dark{% endif %}
        {% if followed %}
            btn-default
        {% else %}
            {% if dark %}btn-dark{% else %}btn-light{% endif %}
        {% endif %}
        {% if followed %}followed{% endif %}" data-id="{{ user.id }}">
        <span class="for-follow">关注</span><span class="for-unfollow">不再关注</span>
        <span class="divider">|</span>
        <span class="followers-count">{{ user.followers.count() }}</span>
    </div>

    <script>
        $('.dc-user-follow-wap').onOnce('click', function () {
            var userId = $(this).data('id');
            var followed = $(this).hasClass('followed');
            var _this = $(this);
            var $count = _this.find('.followers-count');
            var url = urlFor('user.follow', {uid: userId});

            if (!g.signin) {
                window.location = urlFor('account.signin');
                return;
            }

            $.ajax({
                url: url,
                method: 'post',
                dataType: 'json'
            }).done(function (response) {
                if (response.result) {
                    if (response.followed) {
                        _this.addClass('followed').addClass('btn-default');
                        if (_this.hasClass('dark')) {
                            _this.removeClass('btn-dark');
                        } else {
                            _this.removeClass('btn-light');
                        }
                    } else {
                        _this.removeClass('followed').removeClass('btn-default');

                        if (_this.hasClass('dark')) {
                            _this.addClass('btn-dark');
                        } else {
                            _this.addClass('btn-light');
                        }
                    }

                    $count.text(response.followers_count);
                }
            });
        });
    </script>
{% endmacro %}


{# 用户页页头 #}
{% macro user_page_header(user, active='profile', preview=False) %}
    <div class="dc-user-page-header
        {% if user.background %}has-background{% endif %}
        {% if preview %}preview{% endif %}">
        <a class="text-logo link-no-underline" href="{{ url_for('site.index') }}">电</a>

        <div class="commands">
            {% if not g.user or g.user.id != user.id or preview %}
                {{ user_follow_wap(user) }}

                <button type="button" class="dc-hide-commands-trigger btn btn-default">
                    <span class="fa fa-chevron-down"></span>

                    <div class="dc-hide-commands">
                        <a href="#" target="_blank">向他提问</a>
                        <a href="javascript: void(0)" class="btn-block-user" data-id="{{ user.id }}">屏蔽此人</a>
                        <a href="javascript: void(0)" class="btn-report-user" data-id="{{ user.id }}">举报此人</a>
                    </div>
                </button>
            {% endif %}

            {% if g.user and g.user.id == user.id and not preview %}
                <a href="javascript: void(0)" class="btn btn-default btn-upload-background">
                    设置封面图</a>
                <input type="file" class="input-upload-background" name="background"/>

                <button type="button" class="dc-hide-commands-trigger btn btn-default">
                    <span class="fa fa-chevron-down"></span>

                    <div class="dc-hide-commands">
                        <a href="{{ user.profile_url }}?preview=1" target="_blank">以他人视角查看</a>
                    </div>
                </button>
            {% endif %}
        </div>

        <div class="background-wap"
             {% if user.background %}style="background-image: url({{ user.background_url }});"{% endif %}></div>

        <div class="container text-center">
            <div class="avatar-wap">
                <img src="{{ user.avatar_url }}" class="img-circle user-avatar" alt=""/>
                {% if g.user and g.user.id == user.id %}
                    <span class="btn-upload-avatar">
                        上传头像
                    </span>
                    <input type="file" name="avatar"/>
                {% endif %}
            </div>

            <div class="name">{{ user.name }}</div>

            <div class="desc-wap">
                <div class="desc-outer-wap">
                    <span class="desc-inner-wap">
                        <span class="desc">
                            {% if user.desc %}
                                {{ user.desc }}
                            {% elif g.user.id == user.id %}
                                尚无描述
                            {% endif %}
                        </span>
                        <span class="btn-edit-desc">
                            <span class="fa fa-pencil"></span> 编辑
                        </span>
                    </span>
                </div>
                <div class="desc-edit-wap">
                    <input type="text" class="form-control input-desc" name="desc"
                           placeholder="一句话简介" autocomplete="off"/>
                    <button type="button" class="btn btn-default btn-submit-desc">保存</button>
                </div>
            </div>

            <div class="user-meta-wap">
                <div class="meta-outer-wap">
                    <span class="meta-inner-wap">
                        <span class="user-meta">
                            {% for attr in ['location', 'organization', 'position'] %}
                                {% if user[attr] %}
                                    <span class="{{ attr }}">{{ user[attr] }}</span>
                                    <span class="divider">·</span>
                                {% endif %}
                            {% else %}
                                尚未填写相关资料
                            {% endfor %}
                        </span>
                        <span class="btn-edit-meta">
                            <span class="fa fa-pencil"></span> 编辑
                        </span>
                    </span>
                </div>

                <div class="meta-edit-wap">
                    <input type="text" class="form-control input-location" name="location"
                           placeholder="地点" autocomplete="off"/>
                    <input type="text" class="form-control input-organization" name="organization"
                           placeholder="组织" autocomplete="off"/>
                    <input type="text" class="form-control input-position" name="position"
                           placeholder="职位" autocomplete="off"/>
                    <button type="button" class="btn btn-default btn-submit-meta">保存</button>
                </div>
            </div>

            <div class="follows-data">
                <span class="item">
                    <span class="count">{{ user.followings.count() }}</span>
                    <br/>
                    关注
                </span><span class="item">
                    <span class="count">{{ user.followers.count() }}</span>
                    <br/>
                    关注者
                </span>
            </div>

            <ul class="nav nav-tabs nav-tabs-block">
                <li {% if active == 'profile' %}class="active"{% endif %}>
                    <a href="{{ user.profile_url }}">主页</a>
                </li>
                <li {% if active == 'questions_and_answers' %}class="active"{% endif %}>
                    <a href="{{ url_for('user.questions_and_answers', uid=user.id) }}">问答</a>
                </li>
                <li {% if active == 'achievements' %}class="active"{% endif %}>
                    <a href="{{ url_for('user.achievements', uid=user.id) }}">成就</a>
                </li>
            </ul>
        </div>
    </div>

    <script>
        (function () {
            // 上传背景图
            var bgUploader = simple.uploader({
                url: urlFor('account.upload_background'),
                fileKey: 'file',
                connectionCount: 1
            });

            $('.btn-upload-background').click(function () {
                $("input[name='background']").click();
            });

            $("input[name='background']").on('change', function (e) {
                bgUploader.upload(this.files);
            });

            bgUploader.on('uploadsuccess', function (e, file, response) {
                response = JSON.parse(response);
                if (response.result) {
                    $('.background-wap').css({
                        'background-image': 'url(' + response.url + ')'
                    });
                    $('.dc-user-page-header').addClass('has-background');
                }
            });

            // 上传头像
            var avatarUploader = simple.uploader({
                url: urlFor('account.upload_avatar'),
                fileKey: 'file',
                connectionCount: 1
            });

            $('.btn-upload-avatar').click(function () {
                $("input[name='avatar']").click();
            });

            $("input[name='avatar']").on('change', function (e) {
                avatarUploader.upload(this.files);
            });

            avatarUploader.on('uploadsuccess', function (e, file, response) {
                response = JSON.parse(response);
                if (response.result) {
                    $('.user-avatar').attr('src', response.url);
                }
            });

            // 显示desc编辑框
            $('.btn-edit-desc').click(function () {
                var desc = $.trim($('.dc-user-page-header .desc').text());

                $(this).parents('.desc-wap').addClass('edit');
                $('.input-desc').val(desc).focus();

            });

            // 更新desc
            $('.btn-submit-desc').click(function () {
                var $input = $(this).prev();
                var desc = $.trim($input.val());

                $.ajax({
                    url: urlFor('user.update_desc'),
                    method: 'post',
                    dataType: 'json',
                    data: {
                        desc: desc
                    }
                }).done(function (response) {
                    if (response.result) {
                        $('.dc-user-page-header .desc').text(desc);
                        $('.dc-user-page-header .desc-wap').removeClass('edit');
                    }
                });
            });

            // 显示位置、组织、职位编辑框
            $('.btn-edit-meta').click(function () {
                var location, organization, position;

                if ($('.location').length !== 0) {
                    location = $.trim($('.location').text());
                } else {
                    location = "";
                }

                console.log(location);

                if ($('.organization').length !== 0) {
                    organization = $.trim($('.organization').text());
                } else {
                    organization = "";
                }

                if ($('.position').length !== 0) {
                    position = $.trim($('.position').text());
                } else {
                    position = "";
                }

                $(this).parents('.user-meta-wap').addClass('edit');

                $('.input-location').val(location).focus();
                $('.input-organization').val(organization);
                $('.input-position').val(position);
            });

            // 更新位置、组织、职位
            $('.btn-submit-meta').click(function () {
                var location = $.trim($('.input-location').val());
                var organization = $.trim($('.input-organization').val());
                var position = $.trim($('.input-position').val());

                $.ajax({
                    url: urlFor('user.update_meta_info'),
                    method: 'post',
                    dataType: 'json',
                    data: {
                        location: location,
                        organization: organization,
                        position: position
                    }
                }).done(function (response) {
                    var html = "";

                    if (response.result) {
                        if (location) {
                            html += "<span class='location'>" + location + "</span> <span class='divider'>·</span>";
                        }
                        if (organization) {
                            html += " <span class='organization'>" + organization + "</span> <span class='divider'>·</span>";
                        }
                        if (position) {
                            html += " <span class='position'>" + position + "</span> <span class='divider'>·</span>";
                        }

                        $('.user-meta').html(html);
                        $('.user-meta-wap').removeClass('edit');
                    }
                });
            });

            // 举报用户
            $('.btn-report-user').click(function () {
                var id = parseInt($(this).data('id'));
                var _this = $(this);

                $.ajax({
                    url: urlFor('user.report', {uid: id}),
                    dataType: 'json',
                    method: 'post'
                }).done(function (response) {
                    if (response.result) {
                        _this.text('已举报');
                    }
                });
            });
        })();
    </script>
{% endmacro %}

{# 问题FEED #}
{% macro render_question_feed(question) %}
    <div class="content">
        <a href="{{ url_for('question.view', uid=question.id) }}"
           class="question-title">
            {{ question.title }}
        </a>

        <div class="other text-light">
            {# TODO #}
            {% set answers_count = question.answers.count() %}
            {% if answers_count %}
                {{ answers_count }} 个回答
            {% else %}
                还没有回答
            {% endif %}
            <span class="divider">·</span>
            提问于 {{ question.created_at|timesince }}
        </div>

        <div class="commands">
            {{ question_follow_wap(question) }}
            <a href="{{ url_for('question.view', uid=question.id) }}#answer"
               class="btn btn-default btn-answer">
                写答案</a>
        </div>
    </div>
{% endmacro %}


{% macro render_home_feeds(feeds) %}
    <div class="dc-home-feeds">
        {% for feed in feeds %}
            {% if feed.kind == USER_FEED_KIND.ASK_QUESTION %}
                <div class="dc-home-feed feed-follow-question">
                    <div class="meta">
                        <span>提出了问题</span>
                        <span class="time">{{ feed.created_at|timesince }}</span>
                    </div>
                    {{ render_question_feed(feed.question) }}
                </div>
            {% elif feed.kind == USER_FEED_KIND.ANSWER_QUESTION %}
                <div class="dc-home-feed feed-answer-question">
                    <div class="meta">
                        <span>回答了问题</span>
                        <span class="time">{{ feed.created_at|timesince }}</span>
                    </div>
                    {{ render_answer(feed.answer, with_topics=False) }}
                </div>
            {% elif feed.kind == USER_FEED_KIND.UPVOTE_ANSWER %}
                <div class="dc-home-feed feed-upvote-answer">
                    <div class="meta">
                                    <span>赞同了 <a href="{{ feed.answer.user.profile_url }}" class="text-light">
                                        {{ feed.answer.user.name }}</a> 的回答</span>
                        <span class="time">{{ feed.created_at|timesince }}</span>
                    </div>
                    {{ render_answer(feed.answer, with_topics=False) }}
                </div>
            {% elif feed.kind == USER_FEED_KIND.FOLLOW_QUESTION %}
                <div class="dc-home-feed feed-follow-question">
                    <div class="meta">
                        <span>关注了问题</span>
                        <span class="time">{{ feed.created_at|timesince }}</span>
                    </div>
                    {{ render_question_feed(feed.question) }}
                </div>
            {% elif feed.kind == USER_FEED_KIND.FOLLOW_TOPIC %}
                <div class="dc-home-feed feed-follow-topic">
                    <div class="meta">
                        <span>关注了话题</span>
                        <span class="time">{{ feed.created_at|timesince }}</span>
                    </div>
                    <div class="content">
                        <div class="media">
                            <div class="media-left">
                                <a href="{{ url_for('topic.view', uid=feed.topic_id) }}">
                                    <img src="{{ feed.topic.avatar_url }}" class="img-rounded" alt=""/>
                                </a>
                            </div>
                            <div class="media-body">
                                <div class="topic-name">
                                    <a href="{{ url_for('topic.view', uid=feed.topic_id) }}">
                                        {{ feed.topic.name }}</a>
                                </div>
                                <div class="text-light">
                                    {# TODO #}
                                    {{ feed.topic.questions.count() }} 个相关话题
                                </div>
                            </div>
                        </div>

                        {{ topic_follow_wap(feed.topic) }}
                    </div>
                </div>
            {% elif feed.kind == USER_FEED_KIND.FOLLOW_USER %}
                <div class="dc-home-feed feed-follow-user">
                    {% set following_user = feed.following %}
                    <div class="meta">
                        <span>关注了人</span>
                        <span class="time">{{ feed.created_at|timesince }}</span>
                    </div>
                    <div class="content">
                        <div class="media">
                            <div class="media-left">
                                <a href="{{ following_user.profile_url }}">
                                    <img src="{{ following_user.avatar_url }}" class="img-circle" alt=""/>
                                </a>
                            </div>
                            <div class="media-body">
                                <div class="user-name">
                                    <a href="{{ following_user.profile_url }}">
                                        {{ following_user.name }}</a>
                                </div>
                                <div class="desc text-light">{{ following_user.desc or "" }}</div>
                            </div>
                        </div>

                        {{ user_follow_wap(following_user) }}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}
